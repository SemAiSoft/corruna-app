"use strict";(self.webpackChunkcorunna_ui=self.webpackChunkcorunna_ui||[]).push([[9809],{7407:(C,P,n)=>{n.d(P,{q:()=>h});var r=n(4850),s=n(9063),f=n(4650);let h=(()=>{class c extends r.q2{constructor(){super(s.jg.Inventory,"dvt",!0)}savePurchase(a){return this.post({payload:a,endPoint:[s.ve.stockStore,s.ve.stockPurchase]})}moderateStockItem(a){return this.post({payload:a,endPoint:[s.ve.stockStore,s.ve.stockLevelModerator]})}getPreviousVendors(){return this.get({endPoint:[s.kg.stockQuery,s.kg.purchaseVendors]})}getPurchases(){return this.get({endPoint:[s.kg.stockQuery,s.kg.stockPurchase]})}getStockItems(a,u){return this.get({endPoint:[s.kg.stockQuery,s.kg.activeStocks],params:[{k:"query-type",v:a},{k:"branch",v:u}]})}getOldStockItems(){return this.get({endPoint:[s.kg.stockQuery,s.kg.oldStocks]})}getStockItemPurchase(a){return this.get({endPoint:[s.kg.stockQuery,s.kg.stockPurchase],params:[{k:"stockItemId",v:a}]})}getOutOfStocks(a,u){return this.get({endPoint:[s.kg.stockQuery,s.kg.outOfStocks],params:[{k:"os-type",v:a},{k:"branch",v:u}]})}static#t=this.\u0275fac=function(u){return new(u||c)};static#e=this.\u0275prov=f.Yz7({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})()},9809:(C,P,n)=>{n.d(P,{Y:()=>Z});var r=n(4006),s=n(2958),f=n(4201),h=n(9063),c=n(7407),d=n(4715),a=n(7978),u=n(9652),t=n(4650),v=n(2412),p=n(8118),A=n(6895),y=n(6726),O=n(5939),D=n(8093),I=n(2216),x=n(9252),k=n(9492),b=n(1191),S=n(7165);function T(g,E){if(1&g&&(t.TgZ(0,"option",21),t._uU(1),t.qZA()),2&g){const e=E.$implicit;t.Q6J("value",e.branchName),t.xp6(1),t.Oqu(null==e?null:e.branchName)}}const F=function(){return{dateInputFormat:"DD/MM/YYYY",containerClass:"theme-blue",adaptivePosition:!0}};function N(g,E){if(1&g){const e=t.EpF();t.TgZ(0,"div",24)(1,"div",25)(2,"div",26)(3,"label",27),t._uU(4,"Item name:"),t.qZA(),t.TgZ(5,"input",28,29),t.NdJ("change",function(o){t.CHM(e);const l=t.MAs(6),_=t.MAs(11),m=t.oxw(2);return t.KtG(m.avoidDuplicateName(l,_,o))})("typeaheadOnSelect",function(o){t.CHM(e);const l=t.MAs(6),_=t.MAs(11),m=t.oxw(2);return t.KtG(m.avoidDuplicateName(l,_,o))}),t.qZA()(),t.TgZ(7,"div",26)(8,"ion-label"),t._uU(9,"Quantity:"),t.qZA(),t.TgZ(10,"input",30,31),t.NdJ("input",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.unitCostPriceChanged())}),t.qZA()()(),t.TgZ(12,"div",25)(13,"div",26)(14,"ion-label"),t._uU(15,"Unit Cost Price:"),t.qZA(),t.TgZ(16,"input",32),t.NdJ("change",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.unitCostPriceChanged())})("input",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.unitCostPriceChanged())}),t.qZA()(),t.TgZ(17,"div",26)(18,"ion-label"),t._uU(19,"Unit Selling Price:"),t.qZA(),t.TgZ(20,"input",33),t.NdJ("input",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.setPriceOrMarkup("markup"))})("change",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.setPriceOrMarkup("markup"))}),t.qZA()()(),t.TgZ(21,"div",25)(22,"div",26)(23,"label",27),t._uU(24,"Expiry date:"),t.qZA(),t._UZ(25,"input",34),t.qZA(),t.TgZ(26,"div",26)(27,"ion-label"),t._uU(28,"Unit Markup (%):"),t.qZA(),t.TgZ(29,"input",35),t.NdJ("change",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.setPriceOrMarkup("price"))})("input",function(){t.CHM(e);const o=t.oxw(2);return t.KtG(o.setPriceOrMarkup("price"))}),t.qZA()()()()}if(2&g){const e=t.oxw().$implicit,i=t.oxw();let o,l;t.Q6J("formGroupName",i.activePage),t.xp6(5),t.Q6J("disable",null==(o=e.get("id"))?null:o.value)("typeahead",i.oldStockList)("typeaheadOptionField","_id"),t.xp6(5),t.Q6J("disable",null==(l=e.get("id"))?null:l.value),t.xp6(6),t.Q6J("decimal",!0),t.xp6(4),t.Q6J("decimal",!0),t.xp6(5),t.Q6J("bsConfig",t.DdM(9,F)),t.xp6(4),t.Q6J("decimal",!0)}}function w(g,E){if(1&g&&(t.TgZ(0,"div",22),t.YNc(1,N,30,10,"div",23),t.qZA()),2&g){const e=E.index,i=t.oxw();t.xp6(1),t.Q6J("ngIf",i.activePage===e)}}let Z=(()=>{class g{constructor(e,i,o,l,_,m){this.stockService=e,this.platform=i,this.settingsService=o,this.menuService=l,this.navParams=_,this.modalController=m,this.shopBranches=[],this.purchaseVendors=[],this.tableData=[],this.itemCostWorth=0,this.itemsCostWorth=0,this.activePage=0,this.oldStockList=[],this.handler=M=>this.purchaseForm.invalid?(s.F.show({text:h.xR.invalidForm,duration:"long",position:"bottom"}),Promise.resolve()):this.stockService.savePurchase(this.purchaseForm.getRawValue()),this.purchaseForm=new r.cw({vendor:new r.NI(null,r.kI.required),shopBranch:new r.NI(null,r.kI.required),itemsPurchased:new r.Oe([this.purchasedItemsGroup()]),idempotencyKey:new r.NI((0,u.x0)()),createdAt:new r.NI(null)})}ngOnInit(){this.getOldStockItemList();const e={purchaseModal:!0,desc:"fake state for our modal"};history.state.purchaseModal?history.replaceState(e,null):history.pushState(e,null);const i=this.navParams.get("data");i?.purchase&&(this.fillForm(i.purchase),i?.itemIndex>=0&&(this.activePage=i?.itemIndex))}ngOnDestroy(){history.state.purchaseModal&&history.back()}ionViewDidEnter(){this.settingsService.getShopBranches().subscribe(e=>{this.shopBranches=e}),this.stockService.getPreviousVendors().subscribe(e=>{this.purchaseVendors=e})}closeModal(){this.modalController.dismiss()}get itemsPurchasedArr(){return this.purchaseForm.get("itemsPurchased")}purchasedItemsGroup(e){return new r.cw({id:new r.NI(e?._id),shopBranch:new r.NI(e?.shopBranch?.branchName),itemName:new r.NI(e?.itemName??null,r.kI.required),expiryDate:new r.NI(new Date(e?.expiryDate??(0,a.Z)(new Date,1))),quantity:new r.NI(e?.quantity??null,[r.kI.required,r.kI.min(0)]),unitCostPrice:new r.NI(e?.unitCostPrice??null,[r.kI.required,r.kI.min(1)]),unitSellingPrice:new r.NI(e?.unitSellingPrice??null,[r.kI.required,r.kI.min(1)]),unitSellingMarkup:new r.NI(e?.unitSellingMarkup??null)})}addItemPurchased(){this.purchaseForm.valid?(this.itemsPurchasedArr.push(this.purchasedItemsGroup()),this.activePage=this.itemsPurchasedArr.length-1,this.calculateStockWorth()):s.F.show({text:"Please ensure previous items are set up correctly before adding another.",position:"bottom",duration:"long"})}removeItemPurchased(){if(this.itemsPurchasedArr.controls[this.activePage]?.get("id")?.value)s.F.show({text:"Already saved items can not be removed.",position:"bottom",duration:"long"});else{if(this.itemsPurchasedArr.controls.length<=1)return;this.itemsPurchasedArr.removeAt(this.activePage),this.activePage=this.itemsPurchasedArr.length-1,this.calculateStockWorth()}}fillForm(e){this.purchaseForm=new r.cw({id:new r.NI(e._id),vendor:new r.NI(e.vendor,r.kI.required),shopBranch:new r.NI(e.shopBranch?.branchName,r.kI.required),itemsPurchased:new r.Oe([...e.itemsPurchased.map((i,o)=>{this.activePage=o;const l=i.unitCostPrice;return i.unitSellingMarkup=(0,h.QV)((i.unitSellingPrice-l)/l*100??0,2),this.purchasedItemsGroup(i)})]),idempotencyKey:new r.NI((0,u.x0)()),createdAt:new r.NI(new Date(e?.createdAt||new Date))}),this.calculateStockWorth()}getOldStockItemList(){this.stockService.getOldStockItems().subscribe(e=>{this.oldStockList=e})}apiResponse(e){e?._id&&(s.F.show({text:"Purchase saved successfully",duration:"long",position:"top"}),this.purchaseForm.get("id")?.value?this.fillForm(e):this.resetForm())}resetForm(){this.purchaseForm.reset(),this.itemsPurchasedArr.clear(),this.itemsPurchasedArr.push(this.purchasedItemsGroup()),this.purchaseForm.get("idempotencyKey")?.setValue((0,u.x0)()),this.calculateStockWorth()}paginate(e){this.activePage=e.page,this.calculateStockWorth()}calculateStockWorth(){this.itemsCostWorth=0;for(let e=0;e<this.itemsPurchasedArr.length;e++)this.itemsPurchasedArr.controls[e]?.get("quantity")?.invalid||this.itemsPurchasedArr.controls[e]?.get("unitCostPrice")?.invalid||(this.itemsCostWorth+=parseFloat(this.itemsPurchasedArr.controls[e]?.get("quantity")?.value)*parseFloat(this.itemsPurchasedArr.controls[e]?.get("unitCostPrice")?.value)||0);this.itemCostWorth=parseInt(this.itemsPurchasedArr.controls[this.activePage]?.get("quantity")?.value||0)*parseFloat(this.itemsPurchasedArr.controls[this.activePage]?.get("unitCostPrice")?.value||0)||0}avoidDuplicateName(e,i,o){const l=this.itemsPurchasedArr.controls[this.activePage].get("itemName")?.value;if(this.itemsPurchasedArr.getRawValue().filter(m=>m.itemName===l)?.length>1)return s.F.show({text:"Item with same name already exist, please edit the former.",position:"bottom",duration:"long"}),this.itemsPurchasedArr.controls[this.activePage].get("itemName")?.reset(),void e?.focus();if(o?.item){const m=o.item,M=m.unitCostPrice;m.unitSellingMarkup=(0,h.QV)((m.unitSellingPrice-M)/M*100||0,2),this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.setValue(m.unitCostPrice),this.itemsPurchasedArr.controls[this.activePage].get("unitSellingPrice")?.setValue(m.unitSellingPrice),this.itemsPurchasedArr.controls[this.activePage].get("unitSellingMarkup")?.setValue(m.unitSellingMarkup),i?.focus()}}unitCostPriceChanged(){if(this.itemsPurchasedArr.controls[this.activePage].get("unitSellingMarkup")?.value||this.itemsPurchasedArr.controls[this.activePage].get("unitSellingMarkup")?.setValue(20),this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.value&&this.itemsPurchasedArr.controls[this.activePage].get("quantity")?.value){const e=parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitSellingMarkup")?.value)*parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.value||1)/100,i=parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.value)+e;this.itemsPurchasedArr.controls[this.activePage].get("unitSellingPrice")?.setValue((0,h.QV)(i,0))}this.calculateStockWorth()}setPriceOrMarkup(e){if("markup"==e){const i=parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.value),o=parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitSellingPrice")?.value);if(!i||!o)return;const _=(o-i)/i*100;this.itemsPurchasedArr.controls[this.activePage].get("unitSellingMarkup")?.setValue((0,h.QV)(_||0,2))}else{const i=parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitSellingMarkup")?.value)*parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.value||1)/100,o=parseFloat(this.itemsPurchasedArr.controls[this.activePage].get("unitCostPrice")?.value)+i;this.itemsPurchasedArr.controls[this.activePage].get("unitSellingPrice")?.setValue((0,h.QV)(o||0,0))}}static#t=this.\u0275fac=function(i){return new(i||g)(t.Y36(c.q),t.Y36(v.t4),t.Y36(d.g),t.Y36(f.hl),t.Y36(v.X1),t.Y36(p.IN))};static#e=this.\u0275cmp=t.Xpm({type:g,selectors:[["app-purchase-form"]],hostBindings:function(i,o){1&i&&t.NdJ("popstate",function(_){return o.closeModal(_)},!1,t.Jf7)},decls:39,vars:17,consts:[[1,"ion-no-border"],["color","tertiary"],[1,"flex","jc:space-between","px:20","f:black!"],["icon","times",1,"f:1.5rem","text-danger",3,"click"],[1,"ion-padding-horizontal"],[1,"pt:10",3,"formGroup"],[1,"flex","{flex:1}>div","gap:10"],["wordCase","","case","capitalize","formControlName","vendor","type","text","wordCase","","case","capitalize","container","body",1,"form-control","shadow-none",3,"typeahead","typeaheadOptionField"],["formControlName","shopBranch",1,"form-control","form-select","shadow-none"],[3,"value",4,"ngFor","ngForOf"],[1,"flex","ai:center","{flex:1}_h4","my:20","bg:rgba(0,0,0,0.1)","r:5","p:3"],[1,"flex","ai:center","jc:center"],["icon","minus-circle",1,"btn","btn-outline-warning","btn-sm","m-sm-0",3,"click"],[1,"flex","ai:center","jc:center","mx:10"],["icon","plus-circle",1,"btn","btn-outline-success","btn-sm","m-sm-0",3,"click"],["class","form-group","formArrayName","itemsPurchased",4,"ngFor","ngForOf"],[1,"px-1","d-flex","flex-column","py-2"],[1,"p-0",3,"pageLinkSize","rows","first","totalRecords","onPageChange"],[1,"d-flex"],["btnDisabler","","expand","full","fill","solid","shape","round",1,"w-100",3,"handler","disableWhenProcessing","handle"],["expand","full","color","warning","fill","solid","shape","round",1,"w-100",3,"click"],[3,"value"],["formArrayName","itemsPurchased",1,"form-group"],["class","flex flex-direction:column gap:10",3,"formGroupName",4,"ngIf"],[1,"flex","flex-direction:column","gap:10",3,"formGroupName"],[1,"d-flex","gap-2"],[1,"flex-1"],["for",""],["formControlName","itemName","wordCase","","case","capitalize","controlConfig","","container","body","type","text",1,"form-control","shadow-none",3,"disable","typeahead","typeaheadOptionField","change","typeaheadOnSelect"],["self",""],["formControlName","quantity","controlConfig","","digitOnly","","type","number",1,"form-control","shadow-none",3,"disable","input"],["qtty",""],["type","number","digitOnly","","formControlName","unitCostPrice",1,"form-control","shadow-none",3,"decimal","change","input"],["digitOnly","","formControlName","unitSellingPrice","type","number",1,"form-control","shadow-none",3,"decimal","input","change"],["type","text","bsDatepicker","","formControlName","expiryDate",1,"form-control","shadow-none",3,"bsConfig"],["type","number","digitOnly","","formControlName","unitSellingMarkup",1,"form-control","shadow-none",3,"decimal","change","input"]],template:function(i,o){1&i&&(t.TgZ(0,"ion-header",0)(1,"ion-toolbar",1)(2,"h3",2)(3,"span"),t._uU(4," Create/Edit @ "),t.qZA(),t.TgZ(5,"fa-icon",3),t.NdJ("click",function(){return o.modalController.dismiss()}),t.qZA()()()(),t.TgZ(6,"ion-content",4)(7,"form",5)(8,"div",6)(9,"div")(10,"ion-label"),t._uU(11,"Vendor Name:"),t.qZA(),t._UZ(12,"input",7),t.qZA(),t.TgZ(13,"div")(14,"ion-label"),t._uU(15,"Shop Branch:"),t.qZA(),t.TgZ(16,"select",8),t._UZ(17,"option"),t.YNc(18,T,2,2,"option",9),t.qZA()()(),t.TgZ(19,"header",10)(20,"h4",11),t._uU(21),t.ALo(22,"number"),t.qZA(),t.TgZ(23,"fa-icon",12),t.NdJ("click",function(){return o.removeItemPurchased()}),t.qZA(),t.TgZ(24,"h3",13),t._uU(25,"ITEMS"),t.qZA(),t.TgZ(26,"fa-icon",14),t.NdJ("click",function(){return o.addItemPurchased()}),t.qZA(),t.TgZ(27,"h4",11),t._uU(28),t.ALo(29,"number"),t.qZA()(),t.TgZ(30,"main"),t.YNc(31,w,2,1,"div",15),t.qZA(),t.TgZ(32,"footer",16)(33,"p-paginator",17),t.NdJ("onPageChange",function(_){return o.paginate(_)}),t.qZA(),t.TgZ(34,"div",18)(35,"ion-button",19),t.NdJ("handle",function(_){return o.apiResponse(_)}),t._uU(36," Save "),t.qZA(),t.TgZ(37,"ion-button",20),t.NdJ("click",function(){return o.resetForm()}),t._uU(38," Reset "),t.qZA()()()()()),2&i&&(t.xp6(7),t.Q6J("formGroup",o.purchaseForm),t.xp6(5),t.Q6J("typeahead",o.purchaseVendors)("typeaheadOptionField","_id"),t.xp6(6),t.Q6J("ngForOf",o.shopBranches),t.xp6(3),t.hij(" ",t.lcZ(22,13,o.itemCostWorth||0)," "),t.xp6(7),t.hij(" ",t.lcZ(29,15,o.itemsCostWorth||0)," "),t.xp6(3),t.Q6J("ngForOf",o.itemsPurchasedArr.controls),t.xp6(2),t.Q6J("pageLinkSize",3)("rows",1)("first",o.activePage)("totalRecords",o.itemsPurchasedArr.length),t.xp6(2),t.Q6J("handler",o.handler)("disableWhenProcessing",!0))},dependencies:[A.sg,A.O5,r._Y,r.YN,r.Kr,r.Fj,r.wV,r.EJ,r.JJ,r.JL,r.sg,r.u,r.x0,r.CE,y.h,O.V,D.j,p.YG,p.W2,p.Gu,p.Q$,p.sr,I.BN,x.L,k.Np,k.Y5,b.Bp,S.D,A.JJ],styles:["[_nghost-%COMP%]{--ion-color-primary: #EA6D35;--ion-color-primary-rgb: 56, 128, 255;--ion-color-primary-contrast: #ffffff;--ion-color-primary-contrast-rgb: 255, 255, 255;--ion-color-primary-shade: #3171e0;--ion-color-primary-tint: #4c8dff;--ion-color-secondary: #1A2031;--ion-color-secondary-rgb: 61, 194, 255;--ion-color-secondary-contrast: #ffffff;--ion-color-secondary-contrast-rgb: 255, 255, 255;--ion-color-secondary-shade: #36abe0;--ion-color-secondary-tint: #50c8ff;--ion-color-tertiary: #F4E9E9;--ion-color-tertiary-rgb: 82, 96, 255;--ion-color-tertiary-contrast: #ffffff;--ion-color-tertiary-contrast-rgb: 255, 255, 255;--ion-color-tertiary-shade: #4854e0;--ion-color-tertiary-tint: #6370ff;--ion-color-success: #2dd36f;--ion-color-success-rgb: 45, 211, 111;--ion-color-success-contrast: #ffffff;--ion-color-success-contrast-rgb: 255, 255, 255;--ion-color-success-shade: #28ba62;--ion-color-success-tint: #42d77d;--ion-color-warning: #ffc409;--ion-color-warning-rgb: 255, 196, 9;--ion-color-warning-contrast: #000000;--ion-color-warning-contrast-rgb: 0, 0, 0;--ion-color-warning-shade: #e0ac08;--ion-color-warning-tint: #ffca22;--ion-color-danger: #eb445a;--ion-color-danger-rgb: 235, 68, 90;--ion-color-danger-contrast: #ffffff;--ion-color-danger-contrast-rgb: 255, 255, 255;--ion-color-danger-shade: #cf3c4f;--ion-color-danger-tint: #ed576b;--ion-color-dark: #222428;--ion-color-dark-rgb: 34, 36, 40;--ion-color-dark-contrast: #ffffff;--ion-color-dark-contrast-rgb: 255, 255, 255;--ion-color-dark-shade: #1e2023;--ion-color-dark-tint: #383a3e;--ion-color-medium: #f3f3f3;--ion-color-medium-rgb: 146, 148, 156;--ion-color-medium-contrast: #ffffff;--ion-color-medium-contrast-rgb: 255, 255, 255;--ion-color-medium-shade: #808289;--ion-color-medium-tint: #9d9fa6;--ion-color-light: #f4f5f8;--ion-color-light-rgb: 244, 245, 248;--ion-color-light-contrast: #000000;--ion-color-light-contrast-rgb: 0, 0, 0;--ion-color-light-shade: #d7d8da;--ion-color-light-tint: #f5f6f9}"]})}return g})()},4715:(C,P,n)=>{n.d(P,{g:()=>h});var r=n(4850),s=n(9063),f=n(4650);let h=(()=>{class c extends r.q2{constructor(){super(s.ih.Setting,"dvt",!0)}saveShopBranch(a){return this.post({endPoint:[s.yv.settingsStore,s.yv.shopBranch],payload:a})}assignToShop(a){return this.put({endPoint:[s.yv.settingsStore,s.yv.shopBranch],payload:a})}getShopBranches(){return this.get({endPoint:[s.wm.settingsQuery,s.wm.shopBranch]})}deleteShopBranch(a){return this.delete({payload:a,endPoint:[s.yv.settingsStore,s.yv.shopBranch]})}static#t=this.\u0275fac=function(u){return new(u||c)};static#e=this.\u0275prov=f.Yz7({token:c,factory:c.\u0275fac,providedIn:"root"})}return c})()},5866:(C,P,n)=>{n.d(P,{Z:()=>h});var r=n(1998),s=n(953),f=n(833);function h(c,d){(0,f.Z)(2,arguments);var a=(0,s.Z)(c),u=(0,r.Z)(d);if(isNaN(u))return new Date(NaN);if(!u)return a;var t=a.getDate(),v=new Date(a.getTime());return v.setMonth(a.getMonth()+u+1,0),t>=v.getDate()?v:(a.setFullYear(v.getFullYear(),v.getMonth(),t),a)}},7978:(C,P,n)=>{n.d(P,{Z:()=>h});var r=n(1998),s=n(5866),f=n(833);function h(c,d){(0,f.Z)(2,arguments);var a=(0,r.Z)(d);return(0,s.Z)(c,12*a)}},9652:(C,P,n)=>{n.d(P,{x0:()=>h});let h=(c=21)=>crypto.getRandomValues(new Uint8Array(c)).reduce((d,a)=>d+((a&=63)<36?a.toString(36):a<62?(a-26).toString(36).toUpperCase():a>62?"-":"_"),"")}}]);